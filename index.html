<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pancake Stack Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            gap: 20px;
        }

        #gameContainer {
            display: flex;
            gap: 20px;
        }

        #gameGrid {
            width: 600px;
            height: 600px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            background-color: #333;
            padding: 5px;
            border-radius: 10px;
        }

        .cell {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell.grill {
            background-color: #8B4513;
            border: 2px solid #654321;
        }

        .cell.plate {
            background-color: #E6E6FA;
            border: 2px solid #D3D3D3;
        }

        .cell.drag-over {
            border-color: #00FF00;
            border-width: 4px;
        }

        .progress-bar {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #FF6B6B;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #FFF;
        }

        .progress-marker.done {
            left: 80%;
            background-color: #00FF00;
        }

        .progress-marker.burnt {
            left: 100%;
            background-color: #FF0000;
        }

        .pancake {
            font-size: 32px;
            cursor: grab;
            margin: 2px;
            position: relative;
            z-index: 10;
        }

        .pancake:active {
            cursor: grabbing;
        }

        .pancake-stack {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            position: absolute;
            bottom: 10px;
        }

        .pancake-stack .pancake {
            margin: -5px 0;
        }

        .stack-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        #sidebar {
            width: 200px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .buy-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .buy-button:hover {
            background-color: #45a049;
        }

        .buy-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .serve-button {
            background-color: #FF6B6B;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .serve-button:hover {
            background-color: #ff5252;
        }

        .serve-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B6B;
            text-align: center;
        }

        .game-over-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-content {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }

        .stars {
            font-size: 48px;
            margin: 20px 0;
        }

        .restart-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .restart-button:hover {
            background-color: #45a049;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameGrid"></div>
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>‚è∞ Time</h3>
                <div class="timer" id="timer">60</div>
            </div>
            
            <div class="sidebar-section">
                <h3>üéØ Current Order</h3>
                <div id="currentOrder">1 Pancake</div>
            </div>
            
            <div class="sidebar-section">
                <h3>üì¶ Resources</h3>
                <div class="resource-item">
                    <span>ü•û Batter: <span id="batterCount">10</span></span>
                    <button class="buy-button" id="buyBatter">Buy ($1)</button>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>üí∞ Money</h3>
                <div id="moneyDisplay">$0</div>
            </div>
        </div>
    </div>

    <div id="gameOverScreen" class="game-over-screen hidden">
        <div class="game-over-content">
            <h2>Level Complete!</h2>
            <div class="stars" id="starsDisplay">‚≠ê‚≠ê‚≠ê</div>
            <div id="finalScore">Final Score: $0</div>
            <button class="restart-button" id="restartButton">Play Again</button>
        </div>
    </div>

    <script>
        class PancakeStackGame {
            constructor() {
                this.initializeGame();
                this.setupEventListeners();
                this.gameLoop();
            }

            initializeGame() {
                // Level 1 configuration
                this.levelConfig = {
                    gridLayout: [
                        'grill', 'grill', 'grill',
                        'grill', 'grill', 'grill',
                        'grill', 'grill', 'plate'
                    ],
                    cookingTime: 3000, // 3 seconds to 80%
                    burntTime: 6000,   // 6 seconds to 100%
                    timeLimit: 60000,  // 60 seconds
                    orders: [1, 2, 1, 3], // sequence that repeats
                    starThresholds: [3, 10, 30]
                };

                // Game state
                this.gameState = {
                    timeRemaining: this.levelConfig.timeLimit,
                    gameRunning: true,
                    batter: 10,
                    money: 0,
                    currentOrderIndex: 0,
                    totalOrdersCompleted: 0
                };

                // Grid state
                this.grid = new Array(9).fill(null).map((_, index) => ({
                    type: this.levelConfig.gridLayout[index],
                    pancakes: [], // stack of pancakes
                    cookingPancake: null // pancake being cooked (for grills)
                }));

                // Pancake tracking
                this.pancakeIdCounter = 0;
                this.cookingPancakes = new Map(); // id -> pancake data

                this.createGrid();
                this.updateUI();
            }

            createGrid() {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';

                this.grid.forEach((cell, index) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = `cell ${cell.type}`;
                    cellDiv.dataset.cellIndex = index;
                    
                    if (cell.type === 'grill') {
                        cellDiv.innerHTML = 'üî•';
                        cellDiv.addEventListener('click', () => this.startCooking(index));
                    } else if (cell.type === 'plate') {
                        cellDiv.innerHTML = 'üçΩÔ∏è';
                        const serveButton = document.createElement('button');
                        serveButton.className = 'serve-button';
                        serveButton.textContent = 'Serve';
                        serveButton.addEventListener('click', () => this.servePlate(index));
                        cellDiv.appendChild(serveButton);
                    }

                    // Add drop zone functionality for plates
                    if (cell.type === 'plate') {
                        cellDiv.addEventListener('dragover', this.handleDragOver.bind(this));
                        cellDiv.addEventListener('drop', this.handleDrop.bind(this));
                        cellDiv.addEventListener('dragenter', this.handleDragEnter.bind(this));
                        cellDiv.addEventListener('dragleave', this.handleDragLeave.bind(this));
                    }

                    gameGrid.appendChild(cellDiv);
                });
            }

            startCooking(cellIndex) {
                if (!this.gameState.gameRunning) return;
                
                const cell = this.grid[cellIndex];
                if (cell.type !== 'grill' || cell.cookingPancake) return;
                if (this.gameState.batter <= 0) return;

                // Consume batter
                this.gameState.batter--;

                // Create pancake
                const pancakeId = this.pancakeIdCounter++;
                const pancake = {
                    id: pancakeId,
                    type: 'plain',
                    progress: 0,
                    startTime: Date.now(),
                    cellIndex: cellIndex
                };

                cell.cookingPancake = pancake;
                this.cookingPancakes.set(pancakeId, pancake);

                this.updateCellDisplay(cellIndex);
                this.updateUI();
            }

            updateCooking() {
                const currentTime = Date.now();
                
                this.cookingPancakes.forEach((pancake, id) => {
                    const elapsed = currentTime - pancake.startTime;
                    pancake.progress = Math.min(100, (elapsed / this.levelConfig.burntTime) * 100);
                    
                    // Auto-remove burnt pancakes
                    if (pancake.progress >= 100) {
                        const cell = this.grid[pancake.cellIndex];
                        cell.cookingPancake = null;
                        this.cookingPancakes.delete(id);
                        this.updateCellDisplay(pancake.cellIndex);
                        return;
                    }
                    
                    this.updateCellDisplay(pancake.cellIndex);
                });
            }

            updateCellDisplay(cellIndex) {
                const cell = this.grid[cellIndex];
                const cellDiv = document.querySelector(`[data-cell-index="${cellIndex}"]`);
                
                if (cell.type === 'grill' && cell.cookingPancake) {
                    const pancake = cell.cookingPancake;
                    const progress = pancake.progress;
                    
                    // Update progress bar
                    let progressBar = cellDiv.querySelector('.progress-bar');
                    if (!progressBar) {
                        progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        progressBar.innerHTML = `
                            <div class="progress-fill"></div>
                            <div class="progress-marker done"></div>
                        `;
                        cellDiv.appendChild(progressBar);
                    }
                    
                    const progressFill = progressBar.querySelector('.progress-fill');
                    progressFill.style.width = `${progress}%`;
                    
                    // Show pancake immediately when batter is placed
                    let pancakeEmoji = cellDiv.querySelector('.pancake');
                    if (!pancakeEmoji) {
                        pancakeEmoji = document.createElement('div');
                        pancakeEmoji.className = 'pancake';
                        pancakeEmoji.dataset.pancakeId = pancake.id;
                        cellDiv.appendChild(pancakeEmoji);
                    }
                    
                    // Update pancake appearance based on progress
                    if (progress < 80) {
                        pancakeEmoji.innerHTML = 'üçû'; // Uncooked bread
                        pancakeEmoji.draggable = false;
                    } else {
                        pancakeEmoji.innerHTML = 'ü•û'; // Cooked pancake
                        pancakeEmoji.draggable = true;
                        pancakeEmoji.addEventListener('dragstart', this.handleDragStart.bind(this));
                    }
                    
                } else if (cell.type === 'grill') {
                    // Clear grill display when no pancake
                    const progressBar = cellDiv.querySelector('.progress-bar');
                    const pancakeEmoji = cellDiv.querySelector('.pancake');
                    if (progressBar) progressBar.remove();
                    if (pancakeEmoji) pancakeEmoji.remove();
                    
                } else if (cell.type === 'plate') {
                    // Update plate display with stacked pancakes
                    const existingStack = cellDiv.querySelector('.pancake-stack');
                    const existingCount = cellDiv.querySelector('.stack-count');
                    if (existingStack) existingStack.remove();
                    if (existingCount) existingCount.remove();
                    
                    if (cell.pancakes.length > 0) {
                        // Add stack count
                        const countDiv = document.createElement('div');
                        countDiv.className = 'stack-count';
                        countDiv.textContent = cell.pancakes.length;
                        cellDiv.appendChild(countDiv);
                        
                        const stackDiv = document.createElement('div');
                        stackDiv.className = 'pancake-stack';
                        
                        cell.pancakes.forEach((pancake, index) => {
                            const pancakeDiv = document.createElement('div');
                            pancakeDiv.className = 'pancake';
                            pancakeDiv.innerHTML = 'ü•û';
                            pancakeDiv.dataset.pancakeId = pancake.id;
                            
                            // Only top pancake is draggable
                            if (index === cell.pancakes.length - 1) {
                                pancakeDiv.draggable = true;
                                pancakeDiv.addEventListener('dragstart', this.handleDragStart.bind(this));
                            }
                            
                            stackDiv.appendChild(pancakeDiv);
                        });
                        
                        cellDiv.appendChild(stackDiv);
                    }
                }
            }

            handleDragStart(e) {
                const pancakeId = e.target.dataset.pancakeId;
                e.dataTransfer.setData('text/plain', pancakeId);
                e.dataTransfer.effectAllowed = 'move';
            }

            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            handleDragEnter(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            handleDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                const pancakeId = parseInt(e.dataTransfer.getData('text/plain'));
                const targetCellIndex = parseInt(e.currentTarget.dataset.cellIndex);
                
                this.movePancake(pancakeId, targetCellIndex);
            }

            movePancake(pancakeId, targetCellIndex) {
                const targetCell = this.grid[targetCellIndex];
                if (targetCell.type !== 'plate') return;

                // Find source of pancake
                let sourcePancake = null;
                let sourceCell = null;
                let sourceIndex = -1;

                // Check if it's a cooking pancake
                if (this.cookingPancakes.has(pancakeId)) {
                    sourcePancake = this.cookingPancakes.get(pancakeId);
                    if (sourcePancake.progress < 80) {
                        // Discard unfinished pancake
                        sourceCell = this.grid[sourcePancake.cellIndex];
                        sourceCell.cookingPancake = null;
                        this.cookingPancakes.delete(pancakeId);
                        this.updateCellDisplay(sourcePancake.cellIndex);
                        return;
                    }
                    
                    // Move finished pancake from grill to plate
                    sourceCell = this.grid[sourcePancake.cellIndex];
                    sourceCell.cookingPancake = null;
                    this.cookingPancakes.delete(pancakeId);
                    
                    // Add to target plate
                    targetCell.pancakes.push({
                        id: pancakeId,
                        type: 'plain'
                    });
                    
                    this.updateCellDisplay(sourcePancake.cellIndex);
                    this.updateCellDisplay(targetCellIndex);
                    return;
                }

                // Check if it's on a plate (top pancake only)
                for (let i = 0; i < this.grid.length; i++) {
                    const cell = this.grid[i];
                    if (cell.type === 'plate' && cell.pancakes.length > 0) {
                        const topPancake = cell.pancakes[cell.pancakes.length - 1];
                        if (topPancake.id === pancakeId) {
                            // Remove from source plate
                            cell.pancakes.pop();
                            
                            // Add to target plate
                            targetCell.pancakes.push(topPancake);
                            
                            this.updateCellDisplay(i);
                            this.updateCellDisplay(targetCellIndex);
                            return;
                        }
                    }
                }
            }

            servePlate(cellIndex) {
                if (!this.gameState.gameRunning) return;
                
                const cell = this.grid[cellIndex];
                if (cell.type !== 'plate' || cell.pancakes.length === 0) return;

                const currentOrder = this.getCurrentOrder();
                const servedPancakes = cell.pancakes.length;
                
                // Calculate payment
                let payment = 0;
                const correctPancakes = Math.min(servedPancakes, currentOrder);
                payment += correctPancakes * 1; // $1 per correct pancake
                
                // Penalty for extra pancakes
                if (servedPancakes > currentOrder) {
                    payment -= (servedPancakes - currentOrder) * 1;
                }
                
                // Ensure payment is not negative
                payment = Math.max(0, payment);
                
                this.gameState.money += payment;
                
                // Clear the plate
                cell.pancakes = [];
                this.updateCellDisplay(cellIndex);
                
                // Move to next order
                this.gameState.currentOrderIndex = (this.gameState.currentOrderIndex + 1) % this.levelConfig.orders.length;
                this.gameState.totalOrdersCompleted++;
                
                this.updateUI();
            }

            getCurrentOrder() {
                return this.levelConfig.orders[this.gameState.currentOrderIndex];
            }

            buyBatter() {
                if (!this.gameState.gameRunning) return;
                
                this.gameState.money -= 1;
                this.gameState.batter += 10;
                this.updateUI();
            }

            updateUI() {
                document.getElementById('timer').textContent = Math.ceil(this.gameState.timeRemaining / 1000);
                document.getElementById('currentOrder').textContent = `${this.getCurrentOrder()} Pancake${this.getCurrentOrder() > 1 ? 's' : ''}`;
                document.getElementById('batterCount').textContent = this.gameState.batter;
                document.getElementById('moneyDisplay').textContent = `$${this.gameState.money}`;
                
                // Update buy button (allow going into debt)
                const buyButton = document.getElementById('buyBatter');
                buyButton.disabled = false;
            }

            gameLoop() {
                if (!this.gameState.gameRunning) return;
                
                this.updateCooking();
                this.gameState.timeRemaining -= 100;
                
                if (this.gameState.timeRemaining <= 0) {
                    this.endGame();
                    return;
                }
                
                this.updateUI();
                
                setTimeout(() => this.gameLoop(), 100);
            }

            endGame() {
                this.gameState.gameRunning = false;
                
                // Calculate stars
                const finalScore = this.gameState.money;
                let stars = 0;
                
                if (finalScore >= this.levelConfig.starThresholds[2]) stars = 3;
                else if (finalScore >= this.levelConfig.starThresholds[1]) stars = 2;
                else if (finalScore >= this.levelConfig.starThresholds[0]) stars = 1;
                
                // Show game over screen
                const gameOverScreen = document.getElementById('gameOverScreen');
                const starsDisplay = document.getElementById('starsDisplay');
                const finalScoreDisplay = document.getElementById('finalScore');
                
                starsDisplay.textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
                finalScoreDisplay.textContent = `Final Score: $${finalScore}`;
                
                gameOverScreen.classList.remove('hidden');
            }

            restart() {
                document.getElementById('gameOverScreen').classList.add('hidden');
                this.initializeGame();
            }

            setupEventListeners() {
                document.getElementById('buyBatter').addEventListener('click', () => this.buyBatter());
                document.getElementById('restartButton').addEventListener('click', () => this.restart());
            }
        }

        // Start the game
        const game = new PancakeStackGame();
    </script>
</body>
</html>